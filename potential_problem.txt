Review Findings

未知角色可绕过权限：assert_can_view_form、assert_can_update_mainform、assert_can_access_block 对非 client/developer 直接 return，等同于授予“管理员”权限，存在越权风险。permissions.py:33-48 · permissions.py:56-71 · permissions.py:134-142
同步路由中直接 asyncio.create_task 会在 FastAPI 的线程池上下文抛出 “no running event loop”，并且异常被悄悄吞掉；应改为 async def 并 await，或用 BackgroundTasks。messages.py:74-116 · messages.py:123-160 · messages.py:167-198
仓库层更新无白名单，任何字段（含 user_id/created_at 等）都可被传入覆盖，容易被滥用或破坏数据一致性。建议限制允许更新字段并过滤输入。forms.py:59-66 · functions.py:33-40 · nonfunctions.py:33-40 · messages.py:36-43
安全配置：SECRET_KEY 回落为 "secret"，一旦缺失环境变量将使用弱密钥，JWT 可被伪造；decode_access_token 全量捕获异常导致真实错误被吞。应强制要求环境变量并捕获特定 JWT 异常。security.py:10-36
模型与迁移不一致：模型将 users.is_active 默认改为 0、blocks.status/type 默认值已设，但迁移未同步默认值，只改了类型/索引，部署后 ORM 默认与 DB 默认不一致。10308d0fa5bb_align_models_to_final_spec_defaults_.py:21-46 · user.py:21-23 · block.py:14-23
认证依赖重复实现：get_current_user 在权限模块和 auth 路由各有一份，未来改动易出现行为漂移，建议保留单一实现并复用。auth.py:67-89 · permissions.py:13-23
兼容层遗漏/重复导出：permissions.py shim 未导出 oauth2_scheme 与 assert_can_delete_file，可能破坏旧引用；models.py shim 未导出枚举类型；crud.py 存在重复别名 create_file。permissions.py:3-34 · models.py:3-14 · crud.py:37-39
如需，我可以按优先级修复：1) 权限角色白名单；2) messages 路由改为异步或后台任务；3) 仓库层更新白名单；4) SECRET_KEY 强制与 JWT 异常处理；5) 补充迁移默认值；6) 合并 get_current_user；7) 修复兼容层导出。