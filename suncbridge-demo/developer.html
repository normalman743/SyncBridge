<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Developer Dashboard - SyncBridge Demo</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #0b1221;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --accent: #38bdf8;
      --accent-strong: #0ea5e9;
      --success: #34d399;
      --warn: #fbbf24;
      --error: #f87171;
      --card: rgba(255, 255, 255, 0.02);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at 20% 20%, rgba(56, 189, 248, 0.12), transparent 25%),
                  radial-gradient(circle at 80% 0%, rgba(14, 165, 233, 0.15), transparent 30%),
                  var(--bg);
      font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      color: var(--text);
      display: flex;
      flex-direction: column;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 32px;
    }
    .brand { font-weight: 700; letter-spacing: 0.5px; }
    nav { display: flex; align-items: center; gap: 12px; }
    nav a {
      color: var(--muted);
      text-decoration: none;
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 10px;
      transition: color 0.2s ease, background 0.2s ease;
    }
    nav a:hover { color: var(--text); background: rgba(255, 255, 255, 0.05); }
    .user-chip {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font-size: 13px;
    }
    main {
      flex: 1;
      padding: 18px 22px 40px;
      display: flex;
      justify-content: center;
    }
    .layout {
      width: min(1240px, 100%);
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 16px;
    }
    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      backdrop-filter: blur(6px);
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.35);
    }
    .panel h2 { margin: 0 0 6px; font-size: 18px; }
    .panel p { margin: 0; color: var(--muted); font-size: 14px; line-height: 1.5; }
    .section {
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.02);
      margin-top: 10px;
    }
    .section h4 { margin: 0 0 8px; font-size: 15px; }
    .legend { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .list { display: flex; flex-direction: column; gap: 10px; margin-top: 6px; }
    .req-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.02);
      cursor: pointer;
      transition: border-color 0.2s ease, transform 0.1s ease;
    }
    .req-item:hover { border-color: rgba(56, 189, 248, 0.4); transform: translateY(-1px); }
    .req-item.active { border-color: rgba(56, 189, 248, 0.8); background: rgba(56, 189, 248, 0.06); }
    .req-title { margin: 0 0 6px; font-weight: 600; }
    .req-meta { display: flex; align-items: center; gap: 8px; color: var(--muted); font-size: 12px; flex-wrap: wrap; }
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: #0b1727;
      font-weight: 600;
    }
    .s-preview { background: #cbd5e1; }
    .s-available { background: #67e8f9; }
    .s-inprogress { background: #38bdf8; }
    .s-rewrite { background: #fbbf24; }
    .s-end { background: #34d399; }
    .s-error { background: #f87171; }
    .detail { display: flex; flex-direction: column; gap: 16px; }
    .detail-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
    .detail-title { margin: 0; font-size: 20px; }
    .stack { display: flex; gap: 10px; flex-wrap: wrap; }
    .badge {
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
    }
    .action-bar { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 4px; }
    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }
    .btn:hover { transform: translateY(-1px); border-color: rgba(56, 189, 248, 0.4); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35); }
    .btn.primary { background: linear-gradient(135deg, var(--accent), var(--accent-strong)); border: none; color: #0b1727; font-weight: 600; box-shadow: 0 12px 30px rgba(14, 165, 233, 0.25); }
    .btn.warn { background: linear-gradient(135deg, #fbbf24, #f59e0b); border: none; color: #0b1727; font-weight: 600; box-shadow: 0 12px 30px rgba(245, 158, 11, 0.25); }
    .btn.danger { background: linear-gradient(135deg, #f87171, #ef4444); border: none; color: #0b1727; font-weight: 600; box-shadow: 0 12px 30px rgba(239, 68, 68, 0.25); }
    .btn.small { padding: 6px 10px; font-size: 12px; }
    .fn-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.02);
      margin-top: 8px;
    }
    .fn-title { margin: 0 0 6px; font-weight: 600; }
    .fn-meta { display: flex; flex-wrap: wrap; gap: 8px; color: var(--muted); font-size: 12px; }
    .fn-desc { margin: 0 0 6px; color: var(--muted); font-size: 13px; }
    .callout {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px dashed rgba(56, 189, 248, 0.5);
      background: rgba(56, 189, 248, 0.08);
      color: #cdeafe;
      font-size: 13px;
    }
    .messages { display: flex; flex-direction: column; gap: 12px; }
    .msg { border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; background: rgba(255, 255, 255, 0.02); }
    .msg-head { display: flex; align-items: center; gap: 10px; font-size: 13px; color: var(--muted); flex-wrap: wrap; }
    .msg-body { margin-top: 6px; font-size: 14px; line-height: 1.5; }
    .attachments { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }
    .tag {
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(56, 189, 248, 0.12);
      color: #cdeafe;
      border: 1px solid rgba(56, 189, 248, 0.4);
      font-size: 12px;
    }
    .tabs { display: inline-flex; gap: 8px; padding: 6px; border-radius: 12px; border: 1px solid var(--border); background: rgba(255, 255, 255, 0.03); }
    .tab {
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 13px;
      cursor: pointer;
    }
    .tab.active { color: var(--text); border-color: rgba(56, 189, 248, 0.6); background: rgba(56, 189, 248, 0.12); }
    label { font-size: 13px; color: #cbd5e1; display: block; margin-bottom: 6px; }
    textarea, input, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0b1221;
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    textarea:focus, input:focus, select:focus { border-color: rgba(56, 189, 248, 0.6); box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.12); }
    textarea { resize: vertical; min-height: 80px; }
    footer { text-align: center; padding: 16px; color: var(--muted); font-size: 13px; }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">SyncBridge Developer</div>
    <nav>
      <a href="index.html">主页</a>
      <a href="srs.html">SRS</a>
      <a href="client.html">Client</a>
      <a href="developer.html">Developer</a>
      <a href="login.html">登录</a>
    </nav>
    <div class="user-chip" id="userChip"></div>
  </header>

  <main>
    <div class="layout">
      <div class="panel">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <div>
            <h2 style="margin:0;">Developer Board</h2>
            <p style="margin:2px 0 0;color:var(--muted);font-size:13px;">左侧查看已接单与可接单需求</p>
          </div>
        </div>
        <div class="legend" id="legend"></div>
        <div class="section">
          <h4>我接到的</h4>
          <div class="list" id="myList"></div>
        </div>
        <div class="section">
          <h4>待接单（Available）</h4>
          <div class="list" id="availableList"></div>
        </div>
      </div>

      <div class="panel">
        <div class="detail" id="detail">
          <p style="color:var(--muted);margin:0;">请选择左侧需求查看详情</p>
        </div>
      </div>
    </div>
  </main>

  <footer>静态演示，无真实后端调用</footer>

  <script>
    const ATTACH_LIMIT = "10MB";
    const FILE_LIMIT = 10 * 1024 * 1024; // 10MB
    const userName = sessionStorage.getItem("demoUser") || "D-developer";
    const role = "dev";
    sessionStorage.setItem("demoUser", userName);
    sessionStorage.setItem("demoRole", role);
    document.getElementById("userChip").textContent = `${userName} · ${role}`;

    const statuses = [
      { key: "Preview", cls: "s-preview" },
      { key: "Available", cls: "s-available" },
      { key: "In Progress", cls: "s-inprogress" },
      { key: "Rewrite", cls: "s-rewrite" },
      { key: "End", cls: "s-end" },
      { key: "Error", cls: "s-error" }
    ];

    const state = {
      requirements: [
        {
          id: 101,
          title: "导出报表支持 CSV",
          status: "Available",
          updatedAt: "2025-12-12 14:20",
          owner: "D-developer",
          budget: "HKD 18,000",
          expectedTime: "2 周",
          tags: ["export", "report", "csv"],
          desc: "支持对需求列表导出 CSV，过滤条件可复用当前筛选。"
        },
        {
          id: 102,
          title: "需求讨论区支持附件",
          status: "In Progress",
          updatedAt: "2025-12-11 10:05",
          owner: "D-developer",
          budget: "HKD 12,000",
          expectedTime: "1.5 周",
          tags: ["message", "file"],
          desc: "评论区需允许上传 10MB 文件，超限提示使用外链 如github drive。"
        },
        {
          id: 103,
          title: "增加状态历史视图",
          status: "Rewrite",
          updatedAt: "2025-12-10 09:12",
          owner: "client-demo",
          budget: "HKD 9,000",
          expectedTime: "1 周",
          tags: ["status", "timeline"],
          desc: "在详情页展示状态流转记录，便于追踪责任人和时间。"
        },
        {
          id: 104,
          title: "多语言支持与时区适配",
          status: "Available",
          updatedAt: "2025-12-12 16:00",
          owner: "",
          budget: "HKD 8,000",
          expectedTime: "1 周",
          tags: ["i18n", "timezone"],
          desc: "新增英文/中文切换与时区显示，等待接单。"
        },
        {
          id: 105,
          title: "移动端表单优化",
          status: "Available",
          updatedAt: "2025-12-12 17:20",
          owner: "",
          budget: "HKD 7,500",
          expectedTime: "1 周",
          tags: ["mobile", "ui"],
          desc: "调整移动端表单布局与校验提示，等待接单。"
        },
        {
          id: 106,
          title: "日志导出功能",
          status: "End",
          updatedAt: "2025-12-11 18:30",
          owner: "D-developer",
          budget: "HKD 6,500",
          expectedTime: "1 周",
          tags: ["audit", "export"],
          desc: "示例 End 状态，双方确认完成日志导出功能。"
        },
        {
          id: 107,
          title: "外部 API 对接",
          status: "Error",
          updatedAt: "2025-12-12 20:15",
          owner: "client-demo",
          budget: "HKD 4,000",
          expectedTime: "1 周",
          tags: ["integration", "error"],
          desc: "示例 Error 状态，对接失败后终止。"
        }
      ],
      functions: {
        101: [
          { name: "CSV 导出", level: "commercial", desc: "导出当前筛选结果", is_changed: false },
          { name: "字段筛选保持", level: "commercial", desc: "跟随筛选器输出字段", is_changed: false }
        ],
        102: [
          { name: "消息附件上传", level: "commercial", desc: "限制 10MB，支持多附件", is_changed: false },
          { name: "外链提示", level: "lightweight", desc: "超限时推荐使用外链", is_changed: false }
        ],
        103: [
          { name: "状态时间线", level: "commercial", desc: "显示流转与操作者", is_changed: true }
        ],
        104: [
          { name: "语言切换", level: "lightweight", desc: "中文/英文", is_changed: false }
        ],
        105: [
          { name: "移动端校验提示", level: "lightweight", desc: "分步校验", is_changed: false }
        ],
        106: [
          { name: "日志导出", level: "commercial", desc: "导出为 CSV/PDF", is_changed: false }
        ],
        107: [
          { name: "API 对接", level: "commercial", desc: "外部系统接口", is_changed: false }
        ]
      },
      nonfunctions: {
        101: [
          { name: "安全性", level: "commercial", status: "init", weight: 7, is_changed: false },
          { name: "性能（并发100）", level: "commercial", status: "developing", weight: 9, is_changed: false }
        ],
        102: [
          { name: "可用性（3步完成上传）", level: "lightweight", status: "developing", weight: 6, is_changed: false }
        ],
        103: [
          { name: "可追踪性（全链路日志）", level: "commercial", status: "init", weight: 8, is_changed: true }
        ],
        104: [
          { name: "可用性", level: "lightweight", status: "init", weight: 5, is_changed: false }
        ],
        105: [
          { name: "性能", level: "commercial", status: "init", weight: 7, is_changed: false }
        ],
        106: [
          { name: "稳定性", level: "commercial", status: "finish", weight: 8, is_changed: false }
        ],
        107: [
          { name: "合规性", level: "commercial", status: "error", weight: 6, is_changed: false }
        ]
      },
      messages: {
        101: {
          general: [
            { author: "client-demo", role: "client", time: "2025-12-12 09:10", text: "希望导出字段包含当前筛选条件", attachments: [] },
            { author: "D-developer", role: "dev", time: "2025-12-12 14:20", text: "可以，本周内完成", attachments: ["spec-v1.pdf"] },
            { author: "client-demo", role: "client", time: "2025-12-13 10:00", text: "再补充一个字段映射的例子", attachments: ["mapping.xlsx"] }
          ],
          function: [
            { author: "client-demo", role: "client", time: "2025-12-12 09:20", text: "CSV 导出最好支持 UTF-8 BOM", attachments: [], target: "CSV 导出" },
            { author: "D-developer", role: "dev", time: "2025-12-13 11:25", text: "BOM 已加，字段顺序按 UI 排序", attachments: ["export-demo.csv"], target: "CSV 导出" }
          ],
          nonfunction: [
            { author: "D-developer", role: "dev", time: "2025-12-13 12:30", text: "性能压测 100 并发 ok", attachments: ["load-report.pdf"], target: "性能（并发100）" }
          ]
        },
        102: {
          general: [
            { author: "client-demo", role: "client", time: "2025-12-10 12:00", text: "附件大小限制 10MB，超限要有提示", attachments: [] },
            { author: "D-developer", role: "dev", time: "2025-12-11 10:05", text: "已按 10MB 限制处理，今晚推送前端校验", attachments: [] }
          ],
          function: [
            { author: "D-developer", role: "dev", time: "2025-12-11 10:08", text: "上传逻辑已拆分为通用组件", attachments: [], target: "消息附件上传" },
            { author: "client-demo", role: "client", time: "2025-12-12 15:30", text: "外链提示要明显一点", attachments: [], target: "外链提示" }
          ],
          nonfunction: [
            { author: "client-demo", role: "client", time: "2025-12-12 16:00", text: "可用性希望 3 步内完成上传", attachments: ["ux-flow.png"], target: "可用性（3步完成上传）" }
          ]
        },
        103: {
          general: [
            { author: "client-demo", role: "client", time: "2025-12-09 16:02", text: "需要一个状态历史时间线", attachments: [] }
          ],
          function: [
            { author: "D-developer", role: "dev", time: "2025-12-11 09:50", text: "时间线准备加上过滤器", attachments: ["timeline-mock.png"], target: "状态时间线" }
          ],
          nonfunction: [
            { author: "client-demo", role: "client", time: "2025-12-09 16:10", text: "日志粒度要能追踪操作者", attachments: [], target: "可追踪性（全链路日志）" }
          ]
        },
        104: {
          general: [
            { author: "client-demo", role: "client", time: "2025-12-12 16:05", text: "需要多语言与时区选择", attachments: [] }
          ],
          function: [],
          nonfunction: []
        },
        105: {
          general: [
            { author: "client-demo", role: "client", time: "2025-12-12 17:25", text: "移动端表单太挤，需优化", attachments: [] }
          ],
          function: [],
          nonfunction: []
        },
        106: {
          general: [
            { author: "client-demo", role: "client", time: "2025-12-11 18:00", text: "按验收标准完成", attachments: ["log-export.pdf"] },
            { author: "D-developer", role: "dev", time: "2025-12-11 18:30", text: "确认交付完成", attachments: [] }
          ],
          function: [],
          nonfunction: []
        },
        107: {
          general: [
            { author: "client-demo", role: "client", time: "2025-12-12 19:50", text: "接口对接失败，暂停", attachments: [] }
          ],
          function: [],
          nonfunction: []
        }
      },
      histories: {
        101: [
          { from: null, to: "Preview", actor: "client-demo", time: "2025-12-10 09:00", note: "创建表单" },
          { from: "Preview", to: "Available", actor: "client-demo", time: "2025-12-10 09:15", note: "发布需求" }
        ],
        102: [
          { from: null, to: "Preview", actor: "client-demo", time: "2025-12-09 10:30", note: "创建表单" },
          { from: "Preview", to: "Available", actor: "client-demo", time: "2025-12-09 10:45", note: "发布需求" },
          { from: "Available", to: "In Progress", actor: "D-developer", time: "2025-12-10 08:00", note: "开发者接单" }
        ],
        103: [
          { from: null, to: "Preview", actor: "client-demo", time: "2025-12-08 15:10", note: "创建表单" },
          { from: "Preview", to: "Available", actor: "client-demo", time: "2025-12-08 15:30", note: "发布需求" },
          { from: "Available", to: "In Progress", actor: "D-developer", time: "2025-12-09 09:00", note: "开发者接单" },
          { from: "In Progress", to: "Rewrite", actor: "client-demo", time: "2025-12-10 09:12", note: "提出改写" }
        ],
        104: [
          { from: null, to: "Preview", actor: "client-demo", time: "2025-12-12 15:40", note: "创建表单" },
          { from: "Preview", to: "Available", actor: "client-demo", time: "2025-12-12 16:00", note: "发布需求" }
        ],
        105: [
          { from: null, to: "Preview", actor: "client-demo", time: "2025-12-12 17:00", note: "创建表单" },
          { from: "Preview", to: "Available", actor: "client-demo", time: "2025-12-12 17:20", note: "发布需求" }
        ],
        106: [
          { from: null, to: "Preview", actor: "client-demo", time: "2025-12-09 10:00", note: "创建表单" },
          { from: "Preview", to: "Available", actor: "client-demo", time: "2025-12-09 10:20", note: "发布需求" },
          { from: "Available", to: "In Progress", actor: "D-developer", time: "2025-12-09 11:00", note: "开发者接单" },
          { from: "In Progress", to: "End", actor: "D-developer", time: "2025-12-11 18:30", note: "双方确认完成" }
        ],
        107: [
          { from: null, to: "Preview", actor: "client-demo", time: "2025-12-10 14:00", note: "创建表单" },
          { from: "Preview", to: "Available", actor: "client-demo", time: "2025-12-10 14:20", note: "发布需求" },
          { from: "Available", to: "In Progress", actor: "D-developer", time: "2025-12-11 09:00", note: "开发者接单" },
          { from: "In Progress", to: "Rewrite", actor: "client-demo", time: "2025-12-12 18:00", note: "提出改写" },
          { from: "Rewrite", to: "Error", actor: "client-demo", time: "2025-12-12 20:15", note: "协商失败" }
        ]
      },
      subforms: {
        103: {
          previousStatus: "In Progress",
          title: "增加状态历史视图（含时间线）",
          budget: "HKD 10,000",
          expectedTime: "1.5 周",
          tags: ["status", "timeline", "audit"],
          desc: "补充时间线组件，展示操作者与备注。",
          functions: [
            { name: "状态时间线", level: "commercial", desc: "增加时间线与筛选" }
          ],
          nonfunctions: [
            { name: "可追踪性（全链路日志）", level: "commercial", status: "init", weight: 8 }
          ]
        }
      },
      completions: {
        102: { client: false, dev: false },
        106: { client: true, dev: true }
      }
    };

    const myListEl = document.getElementById("myList");
    const availableListEl = document.getElementById("availableList");
    const detailEl = document.getElementById("detail");
    const uiState = { selectedId: null, block: "general", target: "", pendingFiles: {} };

    function statusPill(status) {
      const lower = status.toLowerCase().replace(" ", "");
      const cls = {
        preview: "s-preview",
        available: "s-available",
        inprogress: "s-inprogress",
        rewrite: "s-rewrite",
        end: "s-end",
        error: "s-error"
      }[lower] || "s-preview";
      return `<span class="status-pill ${cls}">${status}</span>`;
    }

    function showToast(msg) {
      alert(msg); // 简单提示即可
    }

    function renderLegend() {
      document.getElementById("legend").innerHTML = statuses.map(s => `<span class="status-pill ${s.cls}">${s.key}</span>`).join("");
    }

    function addHistoryEntry(reqId, fromStatus, toStatus, note) {
      const now = new Date().toISOString().replace("T", " ").substring(0, 16);
      state.histories[reqId] = state.histories[reqId] || [];
      state.histories[reqId].push({
        from: fromStatus,
        to: toStatus,
        actor: userName,
        time: now,
        note: note || ""
      });
      return now;
    }

    function claimRequirement(req) {
      if (req.status !== "Available") {
        showToast("仅 Available 可接单");
        return;
      }
      if (!confirm("确认接单并进入 In Progress？")) return;
      const now = addHistoryEntry(req.id, req.status, "In Progress", "开发者接单");
      req.status = "In Progress";
      req.owner = userName;
      req.updatedAt = now;
      state.completions[req.id] = { client: false, dev: false };
      renderLists();
      renderDetail();
      showToast("已接单，进入 In Progress");
    }

    function markError(req) {
      if (req.status !== "Rewrite") {
        showToast("仅 Rewrite 可标记 Error");
        return;
      }
      if (!confirm("确认标记为 Error？（双方任意一方均可）")) return;
      const now = addHistoryEntry(req.id, req.status, "Error", "标记 Error");
      req.status = "Error";
      req.updatedAt = now;
      state.completions[req.id] = { client: false, dev: false };
      renderLists();
      renderDetail();
    }

    function mergeSubform(req) {
      const subform = state.subforms[req.id];
      if (!subform) {
        showToast("暂无 Subform 可合并");
        return;
      }
      if (!confirm("确认同意 Subform 并返回 In Progress？")) return;
      req.title = subform.title || req.title;
      req.budget = subform.budget || "";
      req.expectedTime = subform.expectedTime || "";
      req.tags = subform.tags ? [...subform.tags] : [];
      req.desc = subform.desc || "";
      state.functions[req.id] = (subform.functions || []).map(f => ({
        name: f.name,
        level: f.level,
        desc: f.desc || "",
        is_changed: false
      }));
      state.nonfunctions[req.id] = (subform.nonfunctions || []).map(n => ({
        name: n.name,
        level: n.level,
        status: n.status,
        weight: n.weight || 5,
        is_changed: false
      }));
      delete state.subforms[req.id];
      const now = addHistoryEntry(req.id, req.status, "In Progress", "Developer 同意 Subform");
      req.status = "In Progress";
      req.updatedAt = now;
      state.completions[req.id] = { client: false, dev: false };
      renderLists();
      renderDetail();
      showToast("已同意 Subform，返回 In Progress");
    }

    function confirmCompletion(req) {
      if (req.status !== "In Progress") {
        showToast("仅 In Progress 可确认完成");
        return;
      }
      if (!confirm("确认完成？需要双方都同意后进入 End")) return;
      const flags = state.completions[req.id] || { client: false, dev: false };
      flags.dev = true;
      addHistoryEntry(req.id, req.status, req.status, "Developer 确认完成");
      state.completions[req.id] = flags;
      if (flags.client && flags.dev) {
        const now = addHistoryEntry(req.id, req.status, "End", "双方确认完成");
        req.status = "End";
        req.updatedAt = now;
      }
      renderLists();
      renderDetail();
      showToast(flags.client && flags.dev ? "需求已完成" : "已记录开发者确认");
    }

    function renderLists() {
      const myReqs = state.requirements
        .filter(r => r.owner === userName || ["In Progress", "Rewrite", "End", "Error"].includes(r.status))
        .sort((a, b) => b.id - a.id);
      const availReqs = state.requirements
        .filter(r => r.status === "Available")
        .sort((a, b) => b.id - a.id);

      myListEl.innerHTML = myReqs.length
        ? myReqs.map(req => `
            <div class="req-item ${uiState.selectedId === req.id ? "active" : ""}" data-id="${req.id}">
              <div class="req-title">${req.title}</div>
              <div class="req-meta">
                ${statusPill(req.status)}
                <span>#${req.id}</span>
                <span>更新: ${req.updatedAt}</span>
              </div>
            </div>
          `).join("")
        : `<p style="color:var(--muted);margin:0;font-size:12px;">暂无已接单需求</p>`;

      availableListEl.innerHTML = availReqs.length
        ? availReqs.map(req => `
            <div class="req-item ${uiState.selectedId === req.id ? "active" : ""}" data-id="${req.id}">
              <div class="req-title">${req.title}</div>
              <div class="req-meta">
                ${statusPill(req.status)}
                <span>#${req.id}</span>
                <span>Owner: ${req.owner || "未指派"}</span>
              </div>
            </div>
          `).join("")
        : `<p style="color:var(--muted);margin:0;font-size:12px;">暂无待接单需求</p>`;
    }

    function renderDetail() {
      const req = state.requirements.find(r => r.id === uiState.selectedId);
      if (!req) {
        detailEl.innerHTML = `<p style="color:var(--muted);margin:0;">请选择左侧需求查看详情</p>`;
        return;
      }
      const fns = state.functions[req.id] || [];
      const nfrs = state.nonfunctions[req.id] || [];
      const messages = state.messages[req.id] || { general: [], function: [], nonfunction: [] };
      const history = state.histories[req.id] || [];
      const completion = state.completions[req.id] || { client: false, dev: false };
      const discussionEnabled = ["In Progress", "Rewrite", "End", "Error"].includes(req.status);
      uiState.pendingFiles[req.id] = uiState.pendingFiles[req.id] || [];

      const activeBlock = ["general", "function", "nonfunction"].includes(uiState.block) ? uiState.block : "general";
      uiState.block = activeBlock;
      const targets = activeBlock === "function"
        ? fns.map(f => f.name)
        : activeBlock === "nonfunction"
          ? nfrs.map(n => n.name)
          : [];
      if (activeBlock === "general") {
        uiState.target = "";
      } else if (targets.length && !targets.includes(uiState.target)) {
        uiState.target = targets[0];
      } else if (!targets.length) {
        uiState.target = "";
      }
      const msgs = messages[activeBlock] || [];

      const actionButtons = [];
      if (req.status === "Available") {
        actionButtons.push(`<button class="btn primary" id="claimBtn">接单进入 In Progress</button>`);
      }
      if (req.status === "Rewrite" && state.subforms[req.id]) {
        actionButtons.push(`<button class="btn warn" id="mergeSubformBtn">同意 Subform 返回 In Progress</button>`);
        actionButtons.push(`<button class="btn danger" id="errorBtn">标记 Error</button>`);
      }
      if (req.status === "In Progress") {
        if (!completion.dev) {
          actionButtons.push(`<button class="btn" id="confirmEndBtn">开发者确认完成</button>`);
        } else {
          actionButtons.push(`<span class="badge">已记录开发者确认</span>`);
        }
      }

      const completionBadges = req.status === "In Progress"
        ? `<span class="badge">Client 确认: ${completion.client ? "是" : "否"}</span>
           <span class="badge">Developer 确认: ${completion.dev ? "是" : "否"}</span>`
        : "";
      const pendingConfirm = req.status === "In Progress"
        ? ["Client", "Developer"].filter(roleLabel => roleLabel === "Client" ? !completion.client : !completion.dev)
        : [];
      const waitingHtml = pendingConfirm.length
        ? `<div class="callout" style="margin-top:8px;">等待 ${pendingConfirm.join(" / ")} 确认</div>`
        : "";
      const actionBarHtml = actionButtons.length || completionBadges
        ? `<div class="action-bar">${actionButtons.join("")}${completionBadges}</div>`
        : "";

      const subform = state.subforms[req.id];
      const subformHtml = subform ? `
        <div class="section">
          <h4>Subform 协商（Rewrite）</h4>
          <p style="color:var(--muted);margin:0 0 6px;">${subform.desc || "暂无描述"}</p>
          ${req.status === "Rewrite" ? `<div class="callout" style="margin:6px 0;">Client 已提交 Subform，等待 Developer 同意或标记 Error</div>` : ""}
          <div class="badge">预算: ${subform.budget || "N/A"}</div>
          <div class="badge">交付: ${subform.expectedTime || "N/A"}</div>
          <div class="badge">标签: ${(subform.tags || []).join(", ")}</div>
          <div style="margin-top:8px;">
            <strong style="font-size:13px;">功能</strong>
            ${(subform.functions || []).map(f => `<div class="fn-card"><div class="fn-title">${f.name}</div><div class="fn-desc">${f.desc || ""}</div><div class="fn-meta"><span class="badge">等级: ${f.level}</span></div></div>`).join("") || "<p style='color:var(--muted);margin:0;'>暂无</p>"}
          </div>
          <div style="margin-top:8px;">
            <strong style="font-size:13px;">非功能</strong>
            ${(subform.nonfunctions || []).map(n => `<div class="fn-card"><div class="fn-title">${n.name}</div><div class="fn-meta"><span class="badge">等级: ${n.level}</span><span class="badge">状态: ${n.status}</span><span class="badge">权重: ${n.weight}</span></div></div>`).join("") || "<p style='color:var(--muted);margin:0;'>暂无</p>"}
          </div>
        </div>
      ` : "";

      detailEl.innerHTML = `
        <div class="detail-header">
          <h3 class="detail-title">${req.title}</h3>
          ${statusPill(req.status)}
        </div>
        <div class="stack">
          <span class="badge">需求号 #${req.id}</span>
          <span class="badge">更新: ${req.updatedAt}</span>
          <span class="badge">负责人: ${req.owner}</span>
          ${req.budget ? `<span class="badge">预算: ${req.budget}</span>` : ""}
          ${req.expectedTime ? `<span class="badge">交付: ${req.expectedTime}</span>` : ""}
          ${req.tags && req.tags.length ? `<span class="badge">标签: ${req.tags.join(", ")}</span>` : ""}
        </div>
        ${actionBarHtml}
        ${waitingHtml}
        <p>${req.desc || "暂无描述"}</p>
        ${subformHtml}
        <div class="section">
          <h4>状态历史</h4>
          <div class="item-list">
            ${history.length ? history.map(h => `
              <div class="item-row" style="display:flex;flex-direction:column;gap:4px;border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:rgba(255,255,255,0.02);">
                <div class="item-title">${h.from ? `${h.from} → ${h.to}` : h.to}</div>
                <div class="item-meta" style="display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:12px;">
                  <span>${h.time}</span>
                  <span>操作者: ${h.actor}</span>
                  ${h.note ? `<span>备注: ${h.note}</span>` : ""}
                </div>
              </div>
            `).join("") : `<p style="color:var(--muted);margin:0;font-size:12px;">暂无状态记录</p>`}
          </div>
        </div>
        <div class="section">
          <h4>功能需求</h4>
          ${fns.length ? fns.map(f => `
            <div class="fn-card">
              <div class="fn-title">${f.name}</div>
              ${f.desc ? `<div class="fn-desc">${f.desc}</div>` : ""}
              <div class="fn-meta">
                <span class="badge">等级: ${f.level}</span>
                ${f.is_changed ? `<span class="badge" style="color:#fbbf24;border-color:rgba(251,191,36,0.6);">is_changed</span>` : `<span class="badge">is_changed: 0</span>`}
              </div>
            </div>
          `).join("") : `<p style="color:var(--muted);margin:0;">暂无功能需求</p>`}
          <h4 style="margin:12px 0 6px;">非功能需求</h4>
          ${nfrs.length ? nfrs.map(n => `
            <div class="fn-card">
              <div class="fn-title">${n.name}</div>
              <div class="fn-meta">
                <span class="badge">等级: ${n.level}</span>
                <span class="badge">状态: ${n.status}</span>
                ${typeof n.weight === "number" ? `<span class="badge">权重: ${n.weight}</span>` : ""}
                ${n.is_changed ? `<span class="badge" style="color:#fbbf24;border-color:rgba(251,191,36,0.6);">is_changed</span>` : `<span class="badge">is_changed: 0</span>`}
              </div>
            </div>
          `).join("") : `<p style="color:var(--muted);margin:0;">暂无非功能需求</p>`}
        </div>
        ${discussionEnabled ? `
          <div class="section">
            <h4>讨论区（Blocks）</h4>
            <div class="action-bar">
              <div class="tabs">
                <button class="tab ${activeBlock === "general" ? "active" : ""}" data-block="general">general</button>
                <button class="tab ${activeBlock === "function" ? "active" : ""}" data-block="function">function</button>
                <button class="tab ${activeBlock === "nonfunction" ? "active" : ""}" data-block="nonfunction">nonfunction</button>
              </div>
              ${activeBlock !== "general" ? `
                <div style="min-width:200px;">
                  <label for="blockTarget">关联目标</label>
                  <select id="blockTarget">
                    ${targets.length ? targets.map(t => `<option value="${t}" ${t === uiState.target ? "selected" : ""}>${t}</option>`).join("") : `<option value="">暂无可选项</option>`}
                  </select>
                </div>
              ` : `<span class="badge">通用讨论区</span>`}
            </div>
            <div class="messages">
              ${msgs.map(m => `
                <div class="msg">
                  <div class="msg-head">
                    <strong>${m.author}</strong>
                    <span>· ${m.role}</span>
                    <span>· ${m.time}</span>
                    ${m.target ? `<span>· ${m.target}</span>` : ""}
                  </div>
                <div class="msg-body">${m.text}</div>
                ${m.attachments && m.attachments.length ? `<div class="attachments">${m.attachments.map(a => `<span class="tag">${a}</span>`).join("")}</div>` : ""}
              </div>
              `).join("") || "<p style='color:var(--muted);margin:0;'>暂无消息</p>"}
            </div>
            <div class="callout">附件大小上限 ${ATTACH_LIMIT}，超限请改用外链（示例：GitHub/Drive 链接）。</div>
            <div class="form" id="msgForm">
              <div>
                <label for="msg-text">新增消息</label>
                <textarea id="msg-text" placeholder="输入消息内容"></textarea>
              </div>
              <div>
                <label for="msg-attachments">附件（≤ ${ATTACH_LIMIT}，逗号分隔，如：spec.pdf, screenshot.png）</label>
                <input id="msg-attachments" placeholder="可选" />
              </div>
              <div>
                <label for="msg-file">选择本地附件（≤ ${ATTACH_LIMIT}）</label>
                <input id="msg-file" type="file" multiple />
              </div>
              <div class="attachments" id="msg-file-list" style="min-height:24px;">
                ${uiState.pendingFiles[req.id].length ? uiState.pendingFiles[req.id].map(f => `<span class="tag">${f}</span>`).join("") : `<span style="color:var(--muted);font-size:12px;">暂无已选文件</span>`}
              </div>
              <button class="btn primary" id="sendMsgBtn">发送</button>
            </div>
          </div>
        ` : `
          <div class="section">
            <h4>讨论区（Blocks）</h4>
            <p style="color:var(--muted);margin:0;">讨论区仅在 In Progress / Rewrite / End / Error 状态开放。</p>
          </div>
        `}
      `;

      const claimBtn = document.getElementById("claimBtn");
      if (claimBtn) claimBtn.addEventListener("click", () => claimRequirement(req));
      const errorBtn = document.getElementById("errorBtn");
      if (errorBtn) errorBtn.addEventListener("click", () => markError(req));
      const mergeSubformBtn = document.getElementById("mergeSubformBtn");
      if (mergeSubformBtn) mergeSubformBtn.addEventListener("click", () => mergeSubform(req));
      const confirmEndBtn = document.getElementById("confirmEndBtn");
      if (confirmEndBtn) confirmEndBtn.addEventListener("click", () => confirmCompletion(req));

      document.querySelectorAll(".tab").forEach((btn) => {
        btn.addEventListener("click", () => {
          uiState.block = btn.dataset.block;
          uiState.target = "";
          renderDetail();
        });
      });
      const blockTarget = document.getElementById("blockTarget");
      if (blockTarget) {
        blockTarget.addEventListener("change", () => {
          uiState.target = blockTarget.value;
        });
      }

      const filePreviewEl = document.getElementById("msg-file-list");
      const fileInputEl = document.getElementById("msg-file");
      const renderPendingFiles = () => {
        if (!filePreviewEl) return;
        const list = uiState.pendingFiles[req.id] || [];
        filePreviewEl.innerHTML = list.length
          ? list.map(f => `<span class="tag">${f}</span>`).join("")
          : `<span style="color:var(--muted);font-size:12px;">暂无已选文件</span>`;
      };
      if (fileInputEl) {
        fileInputEl.addEventListener("change", () => {
          const files = Array.from(fileInputEl.files || []);
          if (!files.length) return;
          uiState.pendingFiles[req.id] = uiState.pendingFiles[req.id] || [];
          files.forEach((f) => {
            if (f.size > FILE_LIMIT) {
              showToast(`${f.name} 超出 ${ATTACH_LIMIT}`);
              return;
            }
            uiState.pendingFiles[req.id].push(f.name);
          });
          fileInputEl.value = "";
          renderPendingFiles();
        });
      }

      const sendMsgBtn = document.getElementById("sendMsgBtn");
      if (sendMsgBtn) {
        sendMsgBtn.addEventListener("click", () => {
          const textEl = document.getElementById("msg-text");
          const attEl = document.getElementById("msg-attachments");
          const text = (textEl.value || "").trim();
          if (!text) {
            showToast("请输入消息内容");
            return;
          }
          const currentBlock = uiState.block || "general";
          const target = uiState.target;
          if ((currentBlock === "function" || currentBlock === "nonfunction") && !target) {
            showToast("请选择关联目标");
            return;
          }
          const atts = (attEl.value || "")
            .split(",")
            .map(s => s.trim())
            .filter(Boolean);
          const pending = uiState.pendingFiles[req.id] || [];
          const mergedAtts = [...atts, ...pending];
          state.messages[req.id] = state.messages[req.id] || { general: [], function: [], nonfunction: [] };
          state.messages[req.id][currentBlock].push({
            author: userName,
            role,
            time: new Date().toISOString().replace("T", " ").substring(0, 16),
            text,
            attachments: mergedAtts,
            target: currentBlock === "general" ? "" : target
          });
          textEl.value = "";
          attEl.value = "";
          if (uiState.pendingFiles[req.id]) uiState.pendingFiles[req.id].length = 0;
          renderPendingFiles();
          renderDetail();
          showToast("消息已添加（前端模拟）");
        });
      }
    }

    myListEl.addEventListener("click", (e) => {
      const item = e.target.closest(".req-item");
      if (!item) return;
      uiState.selectedId = Number(item.dataset.id);
      uiState.block = "general";
      uiState.target = "";
      renderLists();
      renderDetail();
    });
    availableListEl.addEventListener("click", (e) => {
      const item = e.target.closest(".req-item");
      if (!item) return;
      uiState.selectedId = Number(item.dataset.id);
      uiState.block = "general";
      uiState.target = "";
      renderLists();
      renderDetail();
    });

    renderLegend();
    renderLists();
    // 默认选中：优先我的任务，否则可接单
    const myFirst = (state.requirements.find(r => r.owner === userName || ["In Progress", "Rewrite", "End", "Error"].includes(r.status)) || {}).id;
    const availFirst = (state.requirements.find(r => r.status === "Available") || {}).id;
    uiState.selectedId = myFirst || availFirst || null;
    renderLists();
    renderDetail();
  </script>
</body>
</html>
